# SSH文件传输工具

这是一个通过SSH协议传输文件的Python工具，支持用户输入、配置保存、文件传输、MD5校验和自动文件备份功能。**所有传输方法都使用纯代码实现，不依赖外部命令**，确保最大兼容性。

## 📋 目录

- [🚀 快速开始](#-快速开始)
- [✨ 功能特性](#-功能特性)
- [📦 传输方式](#传输方式)
- [🔧 兼容性保证](#兼容性保证)
- [⚡ 性能对比](#性能对比)
- [📦 安装依赖](#安装依赖)
- [💻 使用方法](#使用方法)
- [⚙️ 系统要求](#系统要求)
- [🔧 高级功能和配置](#高级功能和配置)
- [🛠️ 故障排除](#故障排除)
- [📁 备份文件管理](#备份文件管理)
- [🧪 测试建议](#测试建议)
- [📝 更新日志](#更新日志)

## 🚀 快速开始

### 系统要求
- **Python版本**: 3.6+
- **操作系统**: Windows, Linux, macOS
- **网络要求**: 目标服务器需要支持SSH协议
- **依赖包**: 仅需安装paramiko库

### 安装步骤

1. **克隆或下载项目**
   ```bash
   git clone https://github.com/javonhe/tools.git
   cd ssh_file_copy
   ```

2. **安装依赖**
   ```bash
   pip install -r requirements.txt
   ```
   或直接安装：
   ```bash
   pip install paramiko>=2.8.0
   ```

3. **运行程序**
   ```bash
   python ssh_file_copy.py
   ```

## 功能特性

- 🔐 通过SSH/SFTP协议安全传输文件
- 💾 自动保存用户配置，下次启动时作为默认值
- 🔍 MD5校验确保文件传输完整性
- 📝 支持自定义目标文件名
- 🛡️ 密码输入时隐藏显示
- ⚡ 自动创建目标目录（如果不存在）
- 🔄 **自动备份同名文件** - 如果目标目录存在同名文件，会自动重命名为 `.bak` 后缀
- 🔁 **自动重试机制** - 连接失败时自动重试，提高传输成功率
- 🛡️ **连接稳定性检测** - 连接建立后进行稳定性测试，确保连接可靠
- 🔍 **SFTP自动检测** - 自动检测目标设备是否支持SFTP，不支持时自动使用SSH命令传输
- 📦 **大文件传输支持** - 自动检测文件大小，大文件使用分块传输避免命令行长度限制
- 🔒 **文件占用检测** - 自动检测目标文件是否被占用，并尝试终止占用进程
- 🔄 **连接恢复机制** - 传输过程中连接断开时自动重新连接
- 🛡️ **多重传输模式** - 提供多种传输模式，自动选择最佳方案
- 🚀 **SCP协议支持** - 参考原生SCP实现，支持二进制数据传输
- 🔧 **动态分块探测** - 自动探测目标主机支持的最大分块大小
- 🌐 **最大兼容性** - 不依赖外部命令，适用于各种Linux/Unix系统

## 传输方式

程序现在支持5种传输方式，按优先级自动选择：

### 1. SFTP传输（最高优先级）
- **协议**：使用SFTP协议，专门为文件传输设计
- **优势**：
  - 直接传输二进制数据，无需编码
  - 传输速度快，数据量小
  - 支持大文件，内存占用小
  - 支持断点续传
  - 支持压缩传输
- **适用场景**：目标设备支持SFTP时优先使用

### 2. SCP风格传输（新增）
- **协议**：参考原生SCP协议，使用SSH通道直接传输二进制数据
- **优势**：
  - 最接近原生SCP的传输方式
  - 支持SCP协议的文件信息传输
  - 二进制数据传输，无编码开销
  - 更好的错误处理和确认机制
  - **纯代码实现，不依赖外部scp命令**
- **实现方式**：
  - 优先使用Python实现SCP协议接收器
  - 备用Shell脚本实现（使用dd命令）
  - 自动检测Python可用性

### 3. 简单SCP协议传输（新增）
- **协议**：使用最基本的Shell命令实现SCP协议，确保最大兼容性
- **优势**：
  - 使用最基本的shell命令（read, cat, printf）
  - 不依赖Python、dd等工具
  - 最大兼容性，适用于各种Linux/Unix系统
  - 简单的协议实现，易于调试
- **实现方式**：
  ```bash
  # 读取并验证SCP头
  read -r header
  if [[ "$header" != "C0644 <size> <filename>" ]]; then
      echo "Invalid SCP header: $header" >&2
      exit 1
  fi

  # 发送确认
  printf "\x00"

  # 接收文件数据到目标文件
  cat > "target_file"

  # 发送完成确认
  printf "\x00"
  ```

### 4. SSH通道直接传输（新增）
- **协议**：使用SSH通道直接传输二进制数据，通过`cat > file`命令接收
- **优势**：
  - 简单直接的传输方式
  - 无协议开销
  - 支持大文件传输
  - 实时进度显示

### 5. SSH命令传输（备选方案）
- **协议**：使用SSH命令+base64编码
- **优势**：
  - 兼容性好，只需要SSH和base64命令
  - 可以在不支持SFTP的设备上使用
  - 动态分块大小探测
- **劣势**：
  - 数据量增加约33%（base64编码）
  - 传输速度较慢
  - 容易遇到命令长度限制

## 兼容性保证

### 不依赖外部命令
- ❌ 不依赖`scp`命令
- ❌ 不依赖`python3`（有备用方案）
- ❌ 不依赖`dd`命令（有备用方案）
- ✅ 只依赖基本的shell命令（read, cat, printf）
- ✅ 自动检测工具可用性并选择最佳方案

### 系统兼容性
- ✅ Linux系统（各种发行版）
- ✅ Unix系统（BSD, Solaris等）
- ✅ 嵌入式Linux系统
- ✅ 最小化安装的系统
- ✅ 容器环境

## 性能对比

| 传输方法 | 编码开销 | 协议开销 | 稳定性 | 速度 | 兼容性 | 适用场景 |
|---------|---------|---------|--------|------|--------|----------|
| SFTP | 无 | 低 | 高 | 快 | 高 | 推荐首选 |
| SCP风格 | 无 | 中 | 高 | 快 | 高 | 大文件传输 |
| 简单SCP | 无 | 低 | 高 | 快 | 最高 | 兼容性要求 |
| SSH通道 | 无 | 低 | 中 | 快 | 高 | 简单传输 |
| SSH命令 | 33% | 高 | 中 | 慢 | 最高 | 最后备选 |

## 安装依赖

### 依赖包分析

本工具使用最小化依赖设计，主要依赖如下：

#### 必需依赖
- **paramiko>=2.8.0** - SSH协议实现库，提供SSH连接和SFTP功能

#### Python标准库（无需额外安装）
- `os` - 操作系统接口
- `json` - JSON数据处理
- `hashlib` - MD5哈希计算
- `getpass` - 密码输入（隐藏显示）
- `pathlib` - 路径操作
- `typing` - 类型注解
- `time` - 时间相关功能
- `base64` - Base64编码/解码
- `sys` - 系统相关参数
- `stat` - 文件状态信息

### 安装方法

#### 方法1：使用requirements.txt（推荐）
```bash
pip install -r requirements.txt
```

#### 方法2：直接安装paramiko
```bash
pip install paramiko>=2.8.0
```

#### 方法3：使用conda（如果使用Anaconda）
```bash
conda install paramiko
```

### 验证安装

安装完成后，可以通过以下命令验证：

```bash
python -c "import paramiko; print(f'paramiko版本: {paramiko.__version__}')"
```

如果显示版本号，说明安装成功。

## 使用方法

### 基本使用

```bash
python ssh_file_copy.py
```

### 交互式输入

程序启动后会提示您输入以下信息：

1. **IP地址** - 目标服务器的IP地址
2. **端口** - SSH端口（默认22）
3. **用户名** - SSH登录用户名
4. **密码** - SSH登录密码（输入时不会显示）
5. **源文件路径** - 要传输的本地文件路径
6. **目标目录** - 远程服务器上的目标目录
7. **目标文件名** - 可选，留空则使用原文件名

### 配置保存

- 程序会自动将您的输入保存到 `ssh_transfer_config.json` 文件中
- 下次启动时，这些值会作为默认值显示
- 您可以直接按回车使用默认值，或输入新值覆盖

### 文件备份功能

**重要特性**：如果目标目录中已经存在同名文件，程序会：

1. 自动检测同名文件的存在
2. 将原文件重命名为 `.bak` 后缀（例如：`file.txt` → `file.txt.bak`）
3. 然后传输新文件
4. 显示备份操作的结果

### 传输方式自动选择

**新特性**：程序现在会自动检测并选择最佳的传输方式：

1. **SFTP传输** - 如果目标设备支持SFTP，优先使用SFTP传输（更快、更稳定）
2. **SCP风格传输** - 参考原生SCP实现，使用SSH通道直接传输二进制数据
3. **简单SCP协议传输** - 使用基本Shell命令实现SCP协议，最大兼容性
4. **SSH通道直接传输** - 使用SSH通道直接传输二进制数据
5. **SSH命令传输** - 如果其他方式都失败，使用SSH命令+base64编码传输文件
   - **小文件传输** - 文件小于1MB时使用单次传输
   - **大文件传输** - 文件大于1MB时使用分块传输
     - **动态分块探测** - 自动探测目标主机支持的最大分块大小
     - **简单传输模式** - 使用探测到的最优块大小
     - **标准分块传输** - 带重试机制和连接恢复
   - **文件占用检测** - 自动检测目标文件是否被占用，尝试终止占用进程
   - **临时文件传输** - 如果无法终止占用进程，使用临时文件传输后重命名
   - **连接恢复** - 传输过程中连接断开时自动重新连接

### 连接稳定性改进

**新特性**：程序现在包含以下连接稳定性改进：

1. **连接稳定性测试** - 连接建立后执行简单命令测试连接是否稳定
2. **自动重试机制** - 连接失败时自动重试最多3次
3. **超时设置优化** - 增加了banner_timeout和auth_timeout参数
4. **连接等待** - 连接建立后等待1秒确保连接稳定
5. **更好的错误处理** - 区分不同类型的连接错误

### 示例

#### SFTP可用时的传输
```
=== SSH文件传输工具 ===
请输入连接信息 (直接回车使用默认值):
IP地址 []: 192.168.1.100
端口 [22]:
用户名 []: admin
密码: ********
源文件路径 []: /path/to/local/file.txt
目标目录 []: /home/admin/uploads
目标文件名 (可选，留空使用原文件名) []: new_file.txt
配置已保存到: ssh_transfer_config.json

计算源文件MD5...
源文件MD5: d41d8cd98f00b204e9800998ecf8427e
连接到 192.168.1.100:22...
SSH连接成功
连接稳定性测试通过
检测SFTP支持...
✓ SFTP可用
使用SFTP传输文件...
创建SFTP客户端...
检查目标目录: /home/admin/uploads
目标目录已存在
发现同名文件，正在备份: /home/admin/uploads/new_file.txt -> /home/admin/uploads/new_file.txt.bak
✓ 文件备份成功: /home/admin/uploads/new_file.txt.bak
开始传输文件: /path/to/local/file.txt -> /home/admin/uploads/new_file.txt
文件传输完成
验证文件传输...
远程文件MD5: d41d8cd98f00b204e9800998ecf8427e
✓ 文件传输验证成功！MD5值匹配
文件传输任务完成！
```

#### SCP风格传输示例
```
=== SSH文件传输工具 ===
请输入连接信息 (直接回车使用默认值):
IP地址 []: 192.168.1.100
端口 [22]:
用户名 []: admin
密码: ********
源文件路径 []: /path/to/local/file.txt
目标目录 []: /home/admin/uploads
目标文件名 (可选，留空使用原文件名) []: new_file.txt
配置已保存到: ssh_transfer_config.json

计算源文件MD5...
源文件MD5: d41d8cd98f00b204e9800998ecf8427e
连接到 192.168.1.100:22...
SSH连接成功
连接稳定性测试通过
检测SFTP支持...
✗ SFTP不可用: Channel closed.
尝试SCP风格传输...
检测到Python3，使用Python实现SCP协议
使用SCP风格传输文件...
文件大小: 2048576 字节
开始SCP协议传输...
传输进度: 100.0% (2048576/2048576)
✓ SCP协议传输完成
传输时间: 2.34 秒
传输速度: 0.87 MB/s
验证文件传输...
远程文件MD5: d41d8cd98f00b204e9800998ecf8427e
✓ 文件传输验证成功！MD5值匹配
文件传输任务完成！
```

## 高级功能和配置

### 配置文件详解

程序会自动创建 `ssh_transfer_config.json` 配置文件，您也可以手动编辑：

```json
{
  "ip": "192.168.1.100",
  "port": 22,
  "username": "admin",
  "password": "your_password",
  "source_file": "/path/to/local/file.txt",
  "target_dir": "/home/admin/uploads",
  "target_filename": "new_file.txt"
}
```

#### 配置项说明
- `ip`: 目标服务器IP地址
- `port`: SSH端口号（默认22）
- `username`: SSH登录用户名
- `password`: SSH登录密码（明文存储，注意安全）
- `source_file`: 本地源文件路径
- `target_dir`: 远程目标目录
- `target_filename`: 远程文件名（可选，留空使用原文件名）

### 传输方式优先级

程序按以下优先级自动选择传输方式：

1. **SFTP传输** - 最快、最稳定，支持大文件
2. **SCP风格传输** - 二进制传输，无编码开销
3. **简单SCP协议传输** - 最大兼容性
4. **SSH通道直接传输** - 简单直接
5. **SSH命令传输** - 最后备选方案

### 文件备份策略

#### 自动备份
- 同名文件自动重命名为 `.bak` 后缀
- 支持多次备份（每次都会创建新的备份）
- 备份失败不影响主传输流程

#### 手动备份管理
```bash
# 查看备份文件
ls -la /target/directory/*.bak

# 删除旧备份文件
find /target/directory -name "*.bak" -mtime +30 -delete

# 恢复备份文件
mv /target/directory/file.txt.bak /target/directory/file.txt
```

### 性能调优

#### 分块大小优化
- **小文件** (< 1MB): 单次传输
- **中等文件** (1MB - 10MB): 16KB分块
- **大文件** (> 10MB): 32KB分块
- **超大文件** (> 100MB): 动态探测最优分块大小

#### 连接参数优化
```python
# 在代码中可以调整以下参数
ssh_client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
ssh_client.connect(
    hostname=ip,
    port=port,
    username=username,
    password=password,
    timeout=30,           # 连接超时
    banner_timeout=60,    # Banner超时
    auth_timeout=60       # 认证超时
)
```

### 安全考虑

#### 密码安全
- 密码以明文形式存储在配置文件中
- 建议在生产环境中使用SSH密钥认证
- 定期更改密码
- 确保配置文件权限安全

#### SSH密钥认证（推荐）
1. 生成SSH密钥对：
   ```bash
   ssh-keygen -t rsa -b 4096 -C "your_email@example.com"
   ```

2. 将公钥复制到目标服务器：
   ```bash
   ssh-copy-id username@target_ip
   ```

3. 修改代码使用密钥认证：
   ```python
   ssh_client.connect(
       hostname=ip,
       port=port,
       username=username,
       key_filename='/path/to/private_key',
       timeout=30
   )
   ```

#### 网络安全
- 使用SSH隧道加密传输
- 避免在不安全的网络上传输敏感文件
- 定期更新SSH服务器和客户端
- 使用强密码和密钥

### 批量传输

虽然当前版本主要支持单文件传输，但可以通过脚本实现批量传输：

```bash
#!/bin/bash
# 批量传输脚本示例

files=("file1.txt" "file2.txt" "file3.txt")
target_dir="/remote/path"

for file in "${files[@]}"; do
    echo "传输文件: $file"
    python ssh_file_copy.py
    # 或者修改配置文件后运行
done
```

### 监控和日志

#### 启用详细日志
```bash
# 保存详细日志到文件
python ssh_file_copy.py 2>&1 | tee transfer_$(date +%Y%m%d_%H%M%S).log
```

#### 传输统计
程序会显示以下统计信息：
- 传输时间
- 传输速度
- 文件大小
- MD5校验结果

#### 性能监控
- 实时传输进度
- 连接状态监控
- 错误重试次数
- 传输方式选择

## 备份文件管理

- 备份文件会以 `.bak` 后缀保存
- 每次传输同名文件时，都会创建新的备份
- 建议定期清理旧的备份文件以节省磁盘空间
- 可以使用以下命令查看备份文件：
  ```bash
  ls -la /target/directory/*.bak
  ```

## 测试建议

1. **小文件测试** (< 1MB)
   - 验证基本功能
   - 检查传输速度

2. **大文件测试** (> 10MB)
   - 测试分块传输
   - 验证连接稳定性

3. **网络异常测试**
   - 模拟网络中断
   - 验证重连机制

4. **文件占用测试**
   - 模拟文件被占用
   - 验证处理逻辑

5. **兼容性测试**
   - 测试不同Linux发行版
   - 测试最小化安装系统
   - 测试容器环境
